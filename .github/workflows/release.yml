name: Release

on:
  push:
    tags: ['v*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Run tests before release
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run tests
        run: make test

  # Promote existing image from CI (retag sha-xxx to version tag)
  # This is faster and ensures we release the exact same binary that was tested
  promote-image:
    name: Promote Docker Image
    runs-on: ubuntu-latest
    needs: [test]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Get short SHA
        id: short-sha
        run: echo "sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote image (retag sha to version)
        run: |
          SOURCE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}"
          VERSION_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}"
          LATEST_TAG="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

          echo "Promoting image from CI..."
          echo "  Source: $SOURCE_IMAGE"
          echo "  Target: $VERSION_TAG, $LATEST_TAG"

          # Use buildx imagetools to retag without pulling/pushing the full image
          docker buildx imagetools create \
            --tag "$VERSION_TAG" \
            --tag "$LATEST_TAG" \
            "$SOURCE_IMAGE"

          echo "Image promoted successfully!"

      - name: Verify promoted image
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}

  # Build release artifacts
  artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate CRDs
        run: make manifests

      - name: Build Kustomize installer
        run: |
          make build-installer IMG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
          mv dist/install.yaml dist/db-provision-operator-${{ steps.version.outputs.VERSION }}.yaml

      - name: Package CRDs
        run: |
          mkdir -p dist/crds
          cp config/crd/bases/*.yaml dist/crds/
          cd dist && tar -czvf crds-${{ steps.version.outputs.VERSION }}.tar.gz crds/

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Package Helm chart
        run: |
          # Update Chart.yaml version
          sed -i "s/^version:.*/version: ${{ steps.version.outputs.VERSION }}/" charts/db-provision-operator/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"${{ steps.version.outputs.VERSION }}\"/" charts/db-provision-operator/Chart.yaml

          # Update default image tag in values.yaml
          sed -i "s/tag:.*/tag: \"${{ steps.version.outputs.VERSION }}\"/" charts/db-provision-operator/values.yaml

          # Package Helm chart
          helm package charts/db-provision-operator -d dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.yaml *.tar.gz *.tgz > checksums.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.yaml
            dist/*.tar.gz
            dist/*.tgz
            dist/checksums.txt

  # Create GitHub Release
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [promote-image, artifacts]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "## Changes since $PREV_TAG" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "First release of db-provision-operator" >> CHANGELOG.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.VERSION }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-alpha') || contains(github.ref, '-beta') }}
          files: |
            dist/db-provision-operator-${{ steps.version.outputs.VERSION }}.yaml
            dist/crds-${{ steps.version.outputs.VERSION }}.tar.gz
            dist/db-provision-operator-${{ steps.version.outputs.VERSION }}.tgz
            dist/checksums.txt
          generate_release_notes: true

  # Deploy documentation with release (runs first to create gh-pages structure)
  docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [release]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip
          cache-dependency-path: docs/requirements.txt

      - name: Install dependencies
        run: pip install -r docs/requirements.txt

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force

  # Update Helm repository AFTER docs deployment (to preserve charts/ directory)
  helm-repo:
    name: Update Helm Repository
    runs-on: ubuntu-latest
    needs: [docs]  # Run after docs to avoid being overwritten by mkdocs gh-deploy --force
    permissions:
      contents: write
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Download Helm chart
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist/

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update Helm repo index
        run: |
          mkdir -p charts
          cp dist/*.tgz charts/ 2>/dev/null || true
          helm repo index charts --url https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/charts

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add charts/
          git diff --staged --quiet || git commit -m "Update Helm repository for v${{ steps.version.outputs.VERSION }}"
          git push
        continue-on-error: true  # Don't fail if gh-pages doesn't exist yet
