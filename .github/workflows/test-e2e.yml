name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    name: E2E (${{ matrix.database }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        database: [postgresql, mysql]
        include:
          - database: postgresql
            fixture: test/e2e/fixtures/postgresql.yaml
            namespace: postgres
            pod: postgres-0
            port: 5432
            db_timeout: 180s
          - database: mysql
            fixture: test/e2e/fixtures/mysql.yaml
            namespace: mysql
            pod: mysql-0
            port: 3306
            db_timeout: 300s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Verify k3d installation
        run: k3d version

      - name: Create k3d cluster
        run: |
          k3d cluster create e2e-${{ matrix.database }} \
            --agents 1 \
            --wait \
            --timeout 120s

      - name: Wait for cluster ready
        run: |
          kubectl wait --for=condition=Ready nodes --all --timeout=60s
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy ${{ matrix.database }}
        run: |
          kubectl apply -f ${{ matrix.fixture }}
          echo "Waiting for ${{ matrix.database }} pod to be ready (timeout: ${{ matrix.db_timeout }})..."
          kubectl wait --for=condition=Ready pod/${{ matrix.pod }} \
            -n ${{ matrix.namespace }} --timeout=${{ matrix.db_timeout }}

      - name: Verify database is accessible
        run: |
          echo "=== Pods in ${{ matrix.namespace }} namespace ==="
          kubectl get pods -n ${{ matrix.namespace }}
          echo "=== Database pod logs ==="
          kubectl logs ${{ matrix.pod }} -n ${{ matrix.namespace }} --tail=30

      - name: Install CRDs
        run: make install

      - name: Build operator image
        run: make docker-build IMG=db-provision-operator:e2e

      - name: Load image into k3d
        run: k3d image import db-provision-operator:e2e -c e2e-${{ matrix.database }}

      - name: Deploy operator
        run: make deploy IMG=db-provision-operator:e2e

      - name: Wait for operator ready
        run: |
          echo "Waiting for operator deployment..."
          kubectl wait --for=condition=Available \
            deployment/db-provision-operator-controller-manager \
            -n db-provision-operator-system \
            --timeout=120s
          echo "=== Operator pods ==="
          kubectl get pods -n db-provision-operator-system

      - name: Run E2E tests for ${{ matrix.database }}
        env:
          E2E_DATABASE_ENGINE: ${{ matrix.database }}
        run: |
          go test ./test/e2e/... -v -tags=e2e \
            -ginkgo.focus="${{ matrix.database }}" \
            -ginkgo.v \
            -timeout=10m

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Operator logs ==="
          kubectl logs -n db-provision-operator-system \
            -l control-plane=controller-manager --tail=200 || true
          echo ""
          echo "=== Database pod logs ==="
          kubectl logs ${{ matrix.pod }} -n ${{ matrix.namespace }} --tail=100 || true
          echo ""
          echo "=== All DatabaseInstance CRs ==="
          kubectl get databaseinstances -A -o yaml || true
          echo ""
          echo "=== All Database CRs ==="
          kubectl get databases -A -o yaml || true
          echo ""
          echo "=== All DatabaseUser CRs ==="
          kubectl get databaseusers -A -o yaml || true
          echo ""
          echo "=== Events ==="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -50 || true

      - name: Cleanup
        if: always()
        run: k3d cluster delete e2e-${{ matrix.database }} || true
