name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  GO_VERSION_FILE: go.mod
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================================================
  # Stage 1: Parallel Jobs (Lint, Unit Tests, Docker Build)
  # ============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: v2.1.0

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Download dependencies
        run: go mod download

      - name: Run unit tests
        run: make test

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: cover.out
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Build each platform in parallel
  docker-build:
    name: Docker Build (${{ matrix.platform }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        platform:
          - linux/amd64
          # - linux/arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Prepare platform pair
        id: platform
        run: |
          platform=${{ matrix.platform }}
          echo "pair=${platform//\//-}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Build and push by digest
        id: build
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=true
          cache-from: type=gha,scope=build-${{ steps.platform.outputs.pair }}
          cache-to: type=gha,scope=build-${{ steps.platform.outputs.pair }},mode=max

      - name: Export digest
        if: github.event_name != 'pull_request'
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload digest
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ steps.platform.outputs.pair }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

      # For PRs, only build amd64 and export for E2E tests
      - name: Build image for PR (local)
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}
          cache-from: type=gha,scope=build-linux-amd64
          cache-to: type=gha,scope=build-linux-amd64,mode=max

      - name: Save image for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        run: |
          docker save ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} \
            -o /tmp/operator-image.tar

      - name: Upload image artifact for PR
        if: github.event_name == 'pull_request' && matrix.platform == 'linux/amd64'
        uses: actions/upload-artifact@v4
        with:
          name: operator-image
          path: /tmp/operator-image.tar
          retention-days: 1

  # Merge platform images into multi-arch manifest
  docker-merge:
    name: Docker Merge Manifests
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    needs: [docker-build]
    permissions:
      contents: read
      packages: write
    outputs:
      image-sha: sha-${{ steps.short-sha.outputs.sha }}
    steps:
      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Set latest tag for main branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            # Tag with commit SHA (sha-<short-sha>)
            type=sha,prefix=sha-,format=short
            # Tag with branch name
            type=ref,event=branch
            # Tag with PR number
            type=ref,event=pr
            # Tag with semver (v1.0.0 -> 1.0.0, latest)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}},enable=${{ !startsWith(github.ref, 'refs/tags/v0.') }}

      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)

      - name: Inspect image
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.spdx.json

  manifests:
    name: Verify Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Generate manifests
        run: make manifests

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Error: Generated manifests are out of date. Run 'make manifests' and commit the changes."
            git diff
            exit 1
          fi

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Lint Helm chart
        run: helm lint charts/db-provision-operator

      - name: Test Helm chart template
        run: |
          helm template test-release charts/db-provision-operator \
            --set image.tag=test \
            --debug > /dev/null

  generate:
    name: Verify Generated Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ env.GO_VERSION_FILE }}

      - name: Generate code
        run: make generate

      - name: Check for uncommitted changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "Error: Generated code is out of date. Run 'make generate' and commit the changes."
            git diff
            exit 1
          fi

  # ============================================================================
  # Stage 2: Gate (Wait for all parallel jobs)
  # ============================================================================

  gate:
    name: Gate
    runs-on: ubuntu-latest
    # For push: wait for docker-merge (multi-arch manifest)
    # For PR: docker-merge is skipped, so we check docker-build
    needs: [lint, unit-test, docker-build, docker-merge, manifests, generate]
    if: always()
    steps:
      - name: Check job results
        run: |
          # Check required jobs
          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Lint failed"
            exit 1
          fi
          if [[ "${{ needs.unit-test.result }}" != "success" ]]; then
            echo "Unit tests failed"
            exit 1
          fi
          if [[ "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "Docker build failed"
            exit 1
          fi
          if [[ "${{ needs.manifests.result }}" != "success" ]]; then
            echo "Manifests verification failed"
            exit 1
          fi
          if [[ "${{ needs.generate.result }}" != "success" ]]; then
            echo "Generated code verification failed"
            exit 1
          fi
          # docker-merge is skipped for PRs, only check it for push events
          if [[ "${{ github.event_name }}" != "pull_request" ]]; then
            if [[ "${{ needs.docker-merge.result }}" != "success" ]]; then
              echo "Docker merge failed"
              exit 1
            fi
          fi
          echo "All checks passed successfully"

  # ============================================================================
  # Stage 3: E2E Tests (Matrix: Database x Installation Method)
  # ============================================================================

  e2e:
    name: E2E (${{ matrix.database }}/${{ matrix.install_method }})
    runs-on: ubuntu-latest
    needs: [gate]
    strategy:
      fail-fast: false
      matrix:
        database: [postgresql, mysql]
        install_method: [kustomize, helm]
        include:
          - database: postgresql
            fixture: test/e2e/fixtures/postgresql.yaml
            namespace: postgres
            pod: postgres-0
            port: 5432
            db_timeout: 180s
          - database: mysql
            fixture: test/e2e/fixtures/mysql.yaml
            namespace: mysql
            pod: mysql-0
            port: 3306
            db_timeout: 600s

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Get short SHA
        id: short-sha
        run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Install k3d
        run: curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

      - name: Verify k3d installation
        run: k3d version

      - name: Create k3d cluster
        run: |
          k3d cluster create e2e-${{ matrix.database }} \
            --agents 1 \
            --wait \
            --timeout 120s

      - name: Wait for cluster ready
        run: |
          kubectl wait --for=condition=Ready nodes --all --timeout=60s
          kubectl cluster-info
          kubectl get nodes

      - name: Deploy ${{ matrix.database }}
        run: |
          kubectl apply -f ${{ matrix.fixture }}
          echo "Waiting for ${{ matrix.database }} pod to be ready (timeout: ${{ matrix.db_timeout }})..."
          kubectl wait --for=condition=Ready pod/${{ matrix.pod }} \
            -n ${{ matrix.namespace }} --timeout=${{ matrix.db_timeout }}

      - name: Verify database is accessible
        run: |
          echo "=== Pods in ${{ matrix.namespace }} namespace ==="
          kubectl get pods -n ${{ matrix.namespace }}
          echo "=== Database pod logs ==="
          kubectl logs ${{ matrix.pod }} -n ${{ matrix.namespace }} --tail=30

      - name: Install CRDs (kustomize)
        if: matrix.install_method == 'kustomize'
        run: make install

      # For push events: Pull image from registry
      - name: Pull operator image from registry
        if: github.event_name != 'pull_request'
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      # For PRs: Download and load image from artifact
      - name: Download operator image artifact
        if: github.event_name == 'pull_request'
        uses: actions/download-artifact@v4
        with:
          name: operator-image
          path: /tmp

      - name: Load operator image for PR
        if: github.event_name == 'pull_request'
        run: |
          docker load -i /tmp/operator-image.tar

      - name: Load image into k3d
        run: |
          k3d image import ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }} \
            -c e2e-${{ matrix.database }}

      - name: Install Helm
        if: matrix.install_method == 'helm'
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Deploy operator (kustomize)
        if: matrix.install_method == 'kustomize'
        run: |
          make deploy IMG=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ steps.short-sha.outputs.sha }}

      - name: Deploy operator (helm)
        if: matrix.install_method == 'helm'
        run: |
          helm install db-provision-operator ./charts/db-provision-operator \
            --namespace db-provision-operator-system \
            --create-namespace \
            --set image.repository=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} \
            --set image.tag=sha-${{ steps.short-sha.outputs.sha }} \
            --set image.pullPolicy=IfNotPresent \
            --wait \
            --timeout 5m

      - name: Wait for operator ready
        run: |
          echo "Waiting for operator deployment..."
          kubectl wait --for=condition=Available \
            deployment -l app.kubernetes.io/name=db-provision-operator \
            -n db-provision-operator-system \
            --timeout=120s
          echo "=== Operator pods ==="
          kubectl get pods -n db-provision-operator-system

      - name: Run E2E tests for ${{ matrix.database }}
        env:
          E2E_DATABASE_ENGINE: ${{ matrix.database }}
        run: |
          go test ./test/e2e/... -v -tags=e2e \
            -ginkgo.focus="${{ matrix.database }}" \
            -ginkgo.v \
            -timeout=10m

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=============================================="
          echo "=== OPERATOR LOGS (last 500 lines) ==="
          echo "=============================================="
          kubectl logs -n db-provision-operator-system \
            -l control-plane=controller-manager --tail=500 || true
          echo ""
          echo "=============================================="
          echo "=== OPERATOR POD DESCRIPTION ==="
          echo "=============================================="
          kubectl describe pods -n db-provision-operator-system \
            -l control-plane=controller-manager || true
          echo ""
          echo "=============================================="
          echo "=== DATABASE POD LOGS ==="
          echo "=============================================="
          kubectl logs ${{ matrix.pod }} -n ${{ matrix.namespace }} --tail=100 || true
          echo ""
          echo "=============================================="
          echo "=== DATABASE POD DESCRIPTION ==="
          echo "=============================================="
          kubectl describe pod ${{ matrix.pod }} -n ${{ matrix.namespace }} || true
          echo ""
          echo "=============================================="
          echo "=== DatabaseInstance CRs (with status) ==="
          echo "=============================================="
          kubectl get databaseinstances -A -o yaml || true
          echo ""
          echo "=== DatabaseInstance Description ==="
          kubectl describe databaseinstances -A || true
          echo ""
          echo "=============================================="
          echo "=== Database CRs (with status) ==="
          echo "=============================================="
          kubectl get databases -A -o yaml || true
          echo ""
          echo "=== Database Description ==="
          kubectl describe databases -A || true
          echo ""
          echo "=============================================="
          echo "=== DatabaseUser CRs (with status) ==="
          echo "=============================================="
          kubectl get databaseusers -A -o yaml || true
          echo ""
          echo "=== DatabaseUser Description ==="
          kubectl describe databaseusers -A || true
          echo ""
          echo "=============================================="
          echo "=== DatabaseRole CRs (with status) ==="
          echo "=============================================="
          kubectl get databaseroles -A -o yaml || true
          echo ""
          echo "=== DatabaseRole Description ==="
          kubectl describe databaseroles -A || true
          echo ""
          echo "=============================================="
          echo "=== DatabaseGrant CRs (with status) ==="
          echo "=============================================="
          kubectl get databasegrants -A -o yaml || true
          echo ""
          echo "=== DatabaseGrant Description ==="
          kubectl describe databasegrants -A || true
          echo ""
          echo "=============================================="
          echo "=== KUBERNETES EVENTS (last 100) ==="
          echo "=============================================="
          kubectl get events -A --sort-by='.lastTimestamp' | tail -100 || true
          echo ""
          echo "=============================================="
          echo "=== ALL PODS STATUS ==="
          echo "=============================================="
          kubectl get pods -A || true

      - name: Cleanup
        if: always()
        run: k3d cluster delete e2e-${{ matrix.database }} || true

  # ============================================================================
  # Stage 4: CI Success
  # ============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [e2e]
    steps:
      - name: CI pipeline completed
        run: |
          echo "ðŸŽ‰ All CI checks and E2E tests passed!"
          echo ""
          echo "Pipeline summary:"
          echo "  âœ… Lint"
          echo "  âœ… Unit Tests"
          echo "  âœ… Docker Build"
          echo "  âœ… Manifests Verification"
          echo "  âœ… Generated Code Verification"
          echo "  âœ… E2E Tests (PostgreSQL + kustomize)"
          echo "  âœ… E2E Tests (PostgreSQL + helm)"
          echo "  âœ… E2E Tests (MySQL + kustomize)"
          echo "  âœ… E2E Tests (MySQL + helm)"
